#!/usr/bin/env bash

# SessionStart hook to resume autonomous-execution after compaction
# Detects .autonomous-execution-state.json and reloads the skill

INPUT=$(cat)
WORKING_DIR=$(echo "$INPUT" | jq -r '.workingDirectory')
STATE_FILE="$WORKING_DIR/.autonomous-execution-state.json"

# Check if we're resuming autonomous execution
if [ -f "$STATE_FILE" ]; then
  # Find the skill in order of preference, supporting deep namespaced directories
  SKILL_PATH=""

  # Check ~/.claude/skills first (using find for bash 3.2 compatibility)
  SKILL_PATH=$(find ~/.claude/skills -type f -path "*/autonomous-execution/SKILL.md" 2>/dev/null | head -n 1)

  # If not found, check ~/.claude/plugins/cache
  if [ -z "$SKILL_PATH" ]; then
    SKILL_PATH=$(find ~/.claude/plugins/cache -type f -path "*/autonomous-execution/SKILL.md" 2>/dev/null | head -n 1)
  fi

  # If we found the skill, inject it
  if [ -n "$SKILL_PATH" ]; then
    SKILL_CONTENT=$(cat "$SKILL_PATH")

    CONTEXT="<EXTREMELY_IMPORTANT>
AUTONOMOUS EXECUTION RESUME DETECTED

You are resuming autonomous execution after a session interruption (likely compaction).

The .autonomous-execution-state.json file exists in this project, which means you were in the middle of autonomous execution.

Below is the full autonomous-execution skill. Read it carefully and follow the 'Resume Capability' section.

DO NOT START OVER. Resume from current_task_number in the state file.

---

$SKILL_CONTENT

---

</EXTREMELY_IMPORTANT>"

    jq -n --arg context "$CONTEXT" '{
      "additionalContext": $context
    }'
  fi

  exit 0
fi

# No state file, normal session start
exit 0
